== Spring Cloud

=== Comparing Spring Cloud to Quarkus/OpenShift


=== Reviewing Updated Petclinic Microservices Architecture


=== Log in to OpenShift

In order to deploy the microservices into OpenShift, you have to login first.

. On the right-hand side of the screen, select the item: *Login to OpenShift*
+
image::microservices/login-to-openshift-select.png[]

. You should see a screen similar to the one below
+
image::microservices/login-to-openshift-prompts.png[]

. In the new terminal windows enter the your credentials:
.. Username: <your-opentlc-username>
.. Password: <your-opentlc-password>
+
[NOTE]
====
It is important that you use your OpenTLC password. This is the same password that you used to log into OpenTLC. Do NOT use password `openshift`.
====

. Once you are successfully logged in, you should see a screen similar to below:
+
image::microservices/login-to-openshift-success.png[]

. You can safely close this terminal window. Click the "X" in the corner.
+
image::microservices/login-to-openshift-close.png[]

. Back in your original terminal, confirm that you are logged in. Type the following command:

. View the list of projects
+
[source,sh,role="copypaste"]
----
$ oc projects
----

. You will see the following output:
+
----
You have access to the following projects and can switch between them with 'oc project <projectname>':

  * quarkus-abcabc-project - User project for johndoe-redhat.com
    quarkus-rstrst-project - User project for johndoe-redhat.com
    quarkus-xyzxyz-project - User project for johndoe-redhat.com
----

=== Deploying vets-service

. View the files for the `vet-service` application.
+
image::microservices/vets-service-files.png[]

. In your terminal window move to the directory for the `vets-service`:
+
[source,sh,role="copypaste"]
----
$ cd /projects/quarkus-workshop-labs/quarkus-petclinic-vets-service
----

==== Deploy Postgres Database

. Deploy a Postgres database in OpenShift for the `vets-service`:
+
[source,sh,role="copypaste"]
----
oc new-app openshift/postgresql:latest \
            --name=vets-database \
            -e POSTGRESQL_USER=vets \
            -e POSTGRESQL_PASSWORD=mysecretpassword \
            -e POSTGRESQL_DATABASE=vets 
----

. This creates a Postgres DB based on the image: `openshift/postgresql:latest`. The application has the name `vets-database`.

. The database also has the following configurations.

[options="header"]
|===
| Configuration | Description
| POSTGRESQL_USER| User name for the PostgreSQL account to be created.
| POSTGRESQL_PASSWORD | Password for the user account.
| POSTGRESQL_DATABASE | Database name.
|===

. You will see the following output from this command.
+
----
--> Found image 4ed79d1 (4 weeks old) in image stream "openshift/postgresql" under tag "latest" for "openshift/postgresql:latest"

    PostgreSQL 12 
    ------------- 
    PostgreSQL is an advanced Object-Relational database management system (DBMS). The image contains the client and server programs that you'll need to create, run, maintain and access a PostgreSQL DBMS server.

    Tags: database, postgresql, postgresql12, rh-postgresql12


--> Creating resources ...
    imagestreamtag.image.openshift.io "vets-database:latest" created
    deployment.apps "vets-database" created
    service "vets-database" created
--> Success
    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
     'oc expose svc/vets-database' 
    Run 'oc status' to view your app.
----

.  You can monitor the creation of the PostgreSQL pod.
+
[source,sh,role="copypaste"]
----
$ oc get pods 
----

. You will the following output.
+
----
NAME                            READY   STATUS    RESTARTS   AGE
vets-database-cf8d6895b-rtwhd   1/1     Running   0          14m
----

* Once the Postgres database pod is running and ready, we have a running database. We will access the Postgres database in later steps.

==== Quarkus Profiles

Quarkus supports the notion of configuration profiles. These allow you to have multiple configuration in the same file and select between them via a profile name.

By default Quarkus has three profiles, although it is possible to use as many as you like. The default profiles are:

** `dev` - Activated when in development mode (i.e. quarkus:dev)
** `test` - Activated when running tests
** `prod` - The default profile when not running in development or test mode

. Open the file: `src/main/resources/application.properties`

. Make note of the following entries.
+
----
%prod.quarkus.datasource.url=jdbc:postgresql://vets-database:5432/vets
%prod.quarkus.datasource.driver=org.postgresql.Driver
%prod.quarkus.datasource.username=vets
%prod.quarkus.datasource.password=mysecretpassword
%prod.quarkus.datasource.max-size=8
%prod.quarkus.datasource.min-size=2
%prod.quarkus.hibernate-orm.database.generation=drop-and-create
%prod.quarkus.hibernate-orm.sql-load-script=import.sql
%prod.quarkus.hibernate-orm.log.sql=true
----

* The application will use Quarkus Profiles to make use of Production database configurations. Notice that the entries refere to the Postgres database that we deployed to OpenShift.

* When the application is running is OpenShift, it will use the production profile. The production profile is the default when not running in development or test mode.

==== Deploy Quarkus app

Quarkus offers the ability to automatically generate OpenShift resources based on sane default and user supplied configuration. The OpenShift extension provides sensible defaults so that itâ€™s easier for the user to get started with Quarkus on OpenShift.

. In the `vets-service` project, open the `pom.xml` file. 

. Make note of this existing entry:
+
----
    <dependency>
      <groupId>io.quarkus</groupId>
      <artifactId>quarkus-openshift</artifactId>
    </dependency>
----

* By adding this dependency, we now have the ability to configure the OpenShift resource generation and application using the usual `application.properties` approach that Quarkus provides. 

. Open the file: `src/main/resources/application.properties`

. Make note of the following entries:
+
----
#
# Quarkus OpenShift Extension - configuration settings 
#

# Automatically expose the route
quarkus.openshift.expose=true

# Trust a self signed certificate if so presented by the API server
quarkus.kubernetes-client.trust-certs=true
----

* These properties allow you customize deployment of the application. See the documentation for https://quarkus.io/guides/deploying-to-kubernetes#openshift[additional configuration options].


. Deploy the application with the following command.
+
[source,sh,role="copypaste"]
----
$ mvn clean package -Dquarkus.kubernetes.deploy=true
----

. This command accomplishes the following tasks:
* Builds a jar file locally
* Creates a build configuration, which itself creates a new application image from your source code. 
* Creates a deployment configuration to deploy the new image
* Creates a service to provide load-balanced access to the deployment running your image.
* Applies the generated resources.

** The deployment config is conigured to automatically trigger a redeployment when a change in the ImageStream is noticed.

** In other words, any container image build after the initial deployment will automatically trigger redeployment, without the need to delete, update or re-apply the generated resources

. You will see the following output.
+
----
[INFO] Scanning for projects...
[INFO] 
[INFO] --------------< org.acme:quarkus-petclinic-vets-service >---------------
[INFO] Building quarkus-petclinic-vets-service 1.0.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
...
...
INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ServiceAccount vets-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: Service vets-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ImageStream openjdk-11.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ImageStream vets-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: BuildConfig vets-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: DeploymentConfig vets-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: Route vets-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] The deployed application can be accessed at: http://vets-service-quarkus-lmhzb-project.apps.cluster-twbr9.twbr9.sandbox1759.opentlc.com
[INFO] [io.quarkus.deployment.QuarkusAugmentor] Quarkus augmentation completed in 68487ms
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  01:13 min
[INFO] Finished at: 2020-10-24T15:17:55Z
[INFO] ------------------------------------------------------------------------
----
 
==== Verify Deployment

The Quarkus OpenShift extension generates the appropriate OpenShift resources. Let's view these resources.

. View the generated OpenShift resources for imagestreams.
+
[source,sh,role="copypaste"]
----
$ oc get imagestream vets-service
----

. View the buildconfig
+
[source,sh,role="copypaste"]
----
$ oc get buildconfig vets-service
----

. View the deploymentconfig
+
[source,sh,role="copypaste"]
----
$ oc get deploymentconfig vets-service
----

. View the pod for the `vets-service`
+
[source,sh,role="copypaste"]
----
$ oc get pods | grep vets-service
----

. You should see the following output.
+
----
vets-service-1-build             0/1     Completed   0          21m
vets-service-1-deploy            0/1     Completed   0          20m
vets-service-1-mlxnz             1/1     Running     0          20m
----
* Based on this you can see that the `vets-service` is up and running.

=== Deploying visits-service

The `visits-service` is responsible for ....

The `visits-service` has the following architecture.


The `visits-service` exposes the following endpoints.

. View the files for the `visits-service` application.
+
image::microservices/visits-service-files.png[]

. In your terminal window move to the directory for the `visits-service`:
+
[source,sh,role="copypaste"]
----
$ cd /projects/quarkus-workshop-labs/quarkus-petclinic-visits-service
----

==== Deploy Postgres Database

. Deploy a Postgres database in OpenShift for the `visits-service`:
+
[source,sh,role="copypaste"]
----
$ oc new-app -e POSTGRESQL_USER=visits \
  -e POSTGRESQL_PASSWORD=mysecretpassword \
  -e POSTGRESQL_DATABASE=visits openshift/postgresql:latest \
  --name=visits-database
----

. This creates a Postgres DB based on the image: `openshift/postgresql:latest`. The application has the name `visits-database`.

.  You can monitor the creation of the PostgreSQL pod.
+
[source,sh,role="copypaste"]
----
$ oc get pods | grep visits
----

. You will see the following output.
+
----
NAME                            READY   STATUS    RESTARTS   AGE
visits-database-7df7dbb97b-szkql   1/1     Running   0          6s
----

* Once the Postgres database pod is running and ready, we have a running database. 

==== Deploy Quarkus app

We will follow a similar process for deploying the visits service. Again, we'll use the Quarkus OpenShift extension.

. Deploy the Quarkus application.
+
[source,sh,role="copypaste"]
----
$ mvn clean package -Dquarkus.kubernetes.deploy=true
----

. You will see the following output.
+
----
[INFO] Scanning for projects...
[INFO] 
[INFO] ----------------------< org.acme:visits-service >-----------------------
[INFO] Building visits-service 1.0.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
...
...
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Deploying to openshift server: https://172.30.0.1:443/ in namespace: quarkus-lmhzb-project.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ServiceAccount visits-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: Service visits-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ImageStream openjdk-11.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ImageStream visits-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: BuildConfig visits-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: DeploymentConfig visits-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: Route visits-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] The deployed application can be accessed at: http://visits-service-quarkus-lmhzb-project.apps.cluster-twbr9.twbr9.sandbox1759.opentlc.com
[INFO] [io.quarkus.deployment.QuarkusAugmentor] Quarkus augmentation completed in 62653ms
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  01:09 min
[INFO] Finished at: 2020-10-24T17:01:10Z
[INFO] ------------------------------------------------------------------------
----

==== Verify Deployment

. View the pod for the `visits-service`.
+
[source,sh,role="copypaste"]
----
$ oc get pods -w | grep visits-service
----

. Sample output
+
----
visits-service-1-build             0/1     Completed   0          89s
visits-service-1-deploy            0/1     Completed   0          47s
visits-service-1-mlxnz             1/1     Running     0          45s
----

. Run the curl command to view a list of visits (json):
+
[source,sh,role="copypaste"]
----
$ curl http://$(oc get route visits-service -o=go-template --template='{{ .spec.host }}')/pets/visits?petIds=8
----

. You will see the following output:
+
----
[{"id":2,"petId":8,"date":[2013,1,2],"description":"rabies shot"},{"id":3,"petId":8,"date":[2013,1,3],"description":"neutered"}]
----

. Display the web URL for the Swagger UI
+
[source,sh,role="copypaste"]
----
$ echo http://$(oc get route visits-service -o=go-template --template='{{ .spec.host }}')/swagger-ui
----

. Open a web browser and visit the web URL from above.
+
image::microservices/visits-service-swagger-ui.png[]

=== Deploying customers-service

The `customers-service` is responsible for ....

The `customers-service` has the following architecture.

The `customers-service` exposes the following endpoints.

. View the files for the `customers-service` application.
+
image::microservices/customers-service-files.png[]

. In your terminal window move to the directory for the `customers-service`:
+
[source,sh,role="copypaste"]
----
$ cd /projects/quarkus-workshop-labs/quarkus-petclinic-customers-service
----

==== Deploy Postgres Database

. Deploy a Postgres database in OpenShift for the `customers-service`:
+
[source,sh,role="copypaste"]
----
$ oc new-app -e POSTGRESQL_USER=visits \
  -e POSTGRESQL_PASSWORD=mysecretpassword \
  -e POSTGRESQL_DATABASE=visits openshift/postgresql:latest \
  --name=customers-database
----

. This creates a Postgres DB based on the image: `openshift/postgresql:latest`. The application has the name `customers-database`.

.  You can monitor the creation of the PostgreSQL pod.
+
[source,sh,role="copypaste"]
----
$ oc get pods | grep customers
----

. You will the following output.
+
----
NAME                            READY   STATUS    RESTARTS   AGE
customers-database-7df7dbb97b-szkql   1/1     Running   0          6s
----

* Once the Postgres database pod is running and ready, we have a running database. 

==== Deploy Quarkus app

We will follow a similar process for deploying the `customers-service`. Again, we'll use the Quarkus OpenShift extension.

. Deploy the Quarkus application.
+
[source,sh,role="copypaste"]
----
$ mvn clean package -Dquarkus.kubernetes.deploy=true
----

. You will see the following output.
+
----
[INFO] Scanning for projects...
[INFO] 
[INFO] ----------------------< org.acme:customers-service >-----------------------
[INFO] Building customers-service 1.0.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
...
...
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Deploying to openshift server: https://172.30.0.1:443/ in namespace: quarkus-lmhzb-project.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ServiceAccount customers-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: Service customers-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ImageStream openjdk-11.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ImageStream customers-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: BuildConfig customers-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: DeploymentConfig customers-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: Route customers-service.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] The deployed application can be accessed at: http://customers-service-quarkus-lmhzb-project.apps.cluster-twbr9.twbr9.sandbox1759.opentlc.com
[INFO] [io.quarkus.deployment.QuarkusAugmentor] Quarkus augmentation completed in 62653ms
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  01:09 min
[INFO] Finished at: 2020-10-24T17:01:10Z
[INFO] ------------------------------------------------------------------------
----

==== Verify Deployment

. View the pod for the `customers-service`
+
[source,sh,role="copypaste"]
----
$ oc get pods -w | grep customers-service
----

. Sample output
+
----
customers-service-1-build             0/1     Completed   0          89s
customers-service-1-deploy            0/1     Completed   0          47s
customers-service-1-mlxnz             1/1     Running     0          45s
----

. Run the curl command to view a list of visits (json):
+
[source,sh,role="copypaste"]
----
$ curl http://$(oc get route customers-service -o=go-template --template='{{ .spec.host }}')/pets/visits?petIds=8
----

. You will see the following output:
+
----
[{"id":2,"petId":8,"date":[2013,1,2],"description":"rabies shot"},{"id":3,"petId":8,"date":[2013,1,3],"description":"neutered"}]
----

. Display the web URL for the Swagger UI
+
[source,sh,role="copypaste"]
----
$ echo http://$(oc get route customers-service -o=go-template --template='{{ .spec.host }}')/swagger-ui
----

. Open a web browser and visit the web URL from above.
+
<< customers-service-swagger-ui >>

=== Deploying petclinic-web-v2

==== Deploy Postgres Database

==== Deploy Quarkus app

==== Verify Deployment

